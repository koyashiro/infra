AWSTemplateFormatVersion: 2010-09-09
Description: CloudFormation template for Terraform state management with GitHub OIDC integration.

Parameters:
  TerraformTfstateBucketSuffix:
    Type: String

Resources:
  GitHubActionsOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        # Ref: https://github.blog/changelog/2023-06-27-github-actions-update-on-oidc-integration-with-aws/
        - 6938fd4d98bab03faadb97b34396831e3780aea1
        - 1c58a3a8518e8759bf075b76b750d4f2df264fcd

  TerraformTfstateBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub "terraform-tfstate-${TerraformTfstateBucketSuffix}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  TerraformReadGitHubActionsOIDCRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: terraform-read-github-actions-oidc-role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubActionsOIDCProvider
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub: repo:koyashiro/infra:*
      Policies:
        - PolicyName: TerraformTfstateReadPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt TerraformTfstateBucket.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub "${TerraformTfstateBucket.Arn}/*"

  TerraformWriteGitHubActionsOIDCRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: terraform-write-github-actions-oidc-role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubActionsOIDCProvider
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
                token.actions.githubusercontent.com:sub: repo:koyashiro/infra:ref:refs/heads/main
      Policies:
        - PolicyName: TerraformTfstateWritePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt TerraformTfstateBucket.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "${TerraformTfstateBucket.Arn}/*"
